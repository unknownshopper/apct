<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario General</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff">
  <style>
    /* Ajustes menores específicos de esta vista */
    [data-page="inventario"] input#q { min-width: 240px; padding: 0.5rem 0.6rem; border: 1px solid #e5e7eb; border-radius: 8px; }
  </style>
  </head>
<body data-page="inventario">
  <header>
    <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
    <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
    <nav id="primary-nav">
      <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li class="nav-dropdown"><details><summary>Pruebas</summary><ul>
          <li><a href="pruebas.html">Pruebas</a></li>
          <li><a href="stockpruebas.html">Stock de pruebas</a></li>
          <li><a href="listapruebas.html">Lista de pruebas</a></li>
        </ul></details></li>
        <li><a href="tareas.html">Tareas</a></li>
        <li><a href="inspeccion.html">Inspección</a></li>
        <li><a class="active" href="ingral.html">Inventario</a></li>
        <li><a href="actividad.html">Actividad</a></li>
        <li><a href="reportes.html">Reportes</a></li>
      </ul>
    </nav>
    <div class="user-box">
      <span id="user-email"></span>
      <a id="login-link" href="login.html">Login</a>
      <button id="logout-btn" type="button" style="display:none">Salir</button>
    </div>
  </header>
  <main class="wide">
    <h1>Inventario General</h1>
    <div class="page-logo"><img src="img/logopctch.png" alt="PCT"></div>

    <div class="toolbar" role="region" aria-label="Herramientas de tabla">
      <div class="group">
        <input id="q" type="text" placeholder="Buscar..." aria-label="Buscar" />
        <button id="clearQ" class="btn-primary" type="button">Limpiar</button>
      </div>
      <div class="toolbar-count" id="count">0 registros</div>
    </div>

    <div id="inventory-wrapper" class="table-responsive" aria-live="polite">
      <div class="scrollbar-x"><div class="scrollbar-content"></div></div>
      <div class="table-scroll">
        <table class="inventory" id="invTable" aria-describedby="count">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>
  <footer>
    <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    const SRC = 'docs/INVENTARIO GENERAL PCT 2025 NOV.csv';
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const q = document.getElementById('q');
    const clearQ = document.getElementById('clearQ');
    const count = document.getElementById('count');
    const table = document.getElementById('invTable');

    let rows = [];
    let headers = [];
    let view = [];
    let sortCol = -1;
    let sortDir = 'asc';

    function fmt(n){ return n.toLocaleString('es-MX'); }

    function renderHead(){
      const tr = document.createElement('tr');
      headers.forEach((h, idx)=>{
        const th = document.createElement('th');
        th.textContent = h;
        th.setAttribute('role','button');
        th.tabIndex = 0;
        th.dataset.index = String(idx);
        if (idx === sortCol) th.dataset.sort = sortDir;
        th.addEventListener('click', ()=>toggleSort(idx));
        th.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); toggleSort(idx); } });
        tr.appendChild(th);
      });
      thead.innerHTML = '';
      thead.appendChild(tr);
    }

    function renderBody(data){
      const frag = document.createDocumentFragment();
      for (let i=0;i<data.length;i++){
        const tr = document.createElement('tr');
        const row = data[i];
        for (let j=0;j<headers.length;j++){
          const td = document.createElement('td');
          const v = row[j] == null ? '' : row[j];
          td.textContent = v;
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);
      count.textContent = fmt(data.length) + ' registros';
      syncScrollbar();
    }

    function applyFilter(){
      const term = (q.value||'').trim().toLowerCase();
      if (!term){ view = rows; } else {
        view = rows.filter(r => r.some(c => String(c||'').toLowerCase().includes(term)));
      }
      if (sortCol>=0) applySort();
      renderBody(view);
    }

    function toggleSort(col){
      if (sortCol === col){ sortDir = (sortDir==='asc'?'desc':'asc'); }
      else { sortCol = col; sortDir = 'asc'; }
      applySort();
      renderHead();
      renderBody(view);
    }

    function applySort(){
      const dir = sortDir === 'asc' ? 1 : -1;
      view = [...view].sort((a,b)=>{
        const av = a[sortCol] ?? '';
        const bv = b[sortCol] ?? '';
        const an = parseFloat(String(av).replace(/,/g,''));
        const bn = parseFloat(String(bv).replace(/,/g,''));
        const bothNum = !isNaN(an) && !isNaN(bn);
        if (bothNum) return (an>bn?1:an<bn?-1:0)*dir;
        return String(av).localeCompare(String(bv), 'es', { sensitivity:'base' }) * dir;
      });
    }

    function syncScrollbar(){
      const scroller = document.querySelector('.table-scroll');
      const bar = document.querySelector('.scrollbar-x');
      const content = bar.querySelector('.scrollbar-content');
      content.style.width = table.scrollWidth + 'px';
      bar.scrollLeft = scroller.scrollLeft;
      bar.onscroll = () => { scroller.scrollLeft = bar.scrollLeft; };
      scroller.onscroll = () => { bar.scrollLeft = scroller.scrollLeft; };
      let dragging = false; let startX=0; let startLeft=0;
      bar.addEventListener('mousedown', (e)=>{ dragging=true; startX=e.clientX; startLeft=bar.scrollLeft; document.getElementById('inventory-wrapper').classList.add('dragging'); });
      window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-startX; bar.scrollLeft = startLeft + dx; });
      window.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; document.getElementById('inventory-wrapper').classList.remove('dragging'); }});
    }

    function normalizeHeader(h){
      return String(h||'').trim();
    }

    function load(){
      Papa.parse(SRC, {
        download: true,
        skipEmptyLines: 'greedy',
        complete: (res)=>{
          const data = res.data || [];
          if (!data.length){ headers=[]; rows=[]; view=[]; renderHead(); renderBody([]); return; }
          headers = data[0].map(normalizeHeader);
          rows = data.slice(1);
          view = rows;
          renderHead();
          renderBody(view);
        }
      });
    }

    q.addEventListener('input', applyFilter);
    clearQ.addEventListener('click', ()=>{ q.value=''; applyFilter(); q.focus(); });

    document.addEventListener('DOMContentLoaded', load);
  })();
  </script>
</body>
</html>