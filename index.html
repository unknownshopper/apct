<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PCT - Panel de Control y Gestión</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Sistema de gestión integral PCT para control de pruebas, inspecciones, inventario y actividades operacionales.">
    <meta name="keywords" content="PCT, gestión, inspecciones, inventario, control operacional">
    <meta name="author" content="PCT">
    <link rel="canonical" href="https://pc-t.mx/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pc-t.mx/">
    <meta property="og:title" content="PCT - Panel de Control y Gestión">
    <meta property="og:description" content="Sistema de gestión integral PCT para control de pruebas, inspecciones, inventario y actividades operacionales.">
    <meta property="og:site_name" content="PCT">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://pc-t.mx/">
    <meta name="twitter:title" content="PCT - Panel de Control y Gestión">
    <meta name="twitter:description" content="Sistema de gestión integral PCT para control de pruebas, inspecciones, inventario y actividades operacionales.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="img/logo.ico">
    <link rel="shortcut icon" href="img/logo.ico">

    <script>
      (function(){
        var v = Date.now();
        document.write('<link rel="stylesheet" href="styles.css?v=' + v + '">');
      })();
    </script>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#0f172a">
</head>
  <body>
    <header>
        <div class="logo">  <img src="img/logopctch.png" alt="Logo"></div>
        <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
        <nav id="primary-nav">
            <ul>
                <li><a class="active" href="index.html">Dashboard</a></li>
                <li class="nav-dropdown"><details><summary>Pruebas</summary><ul>
                  <li><a href="matestrep.html">MTR Material Test Report</a></li>
                  <li><a href="listmatestrep.html">Lista de pruebas (MTR)</a></li>
                  <li><a href="pruebas.html">Pruebas</a></li>
                  <li><a href="stockpruebas.html">Stock de pruebas</a></li>
                  <li><a href="listapruebas.html">Lista de pruebas</a></li>
                  <li><a href="utt.html">Pruebas UTT</a></li>
                  <li><a href="listutt.html">Lista UTT</a></li>
                  <li><a href="emi.html">Pruebas EMI</a></li>
                  <li><a href="listemi.html">Lista EMI</a></li>
                </ul></details></li>
                <li><a href="tareas.html">Tareas</a></li>
                <li class="nav-dropdown"><details><summary>Inspección</summary><ul>
                  <li><a href="inspeccion.html">Inspección primaria</a></li>
                  <li><a href="reginspecciones.html">Registro de inspecciones</a></li>
                </ul></details></li>
                <li><a href="ingral.html">Inventario</a></li>
                <li class="nav-dropdown"><details><summary>Actividad</summary><ul>
                  <li><a href="actividad.html">Registro de actividad</a></li>
                  <li><a href="regactividad.html">Historial de registros</a></li>
                </ul></details></li>
                <li><a href="reportes.html">Reportes</a></li>
            </ul>
        </nav>
        <div class="user-box">
          <span id="user-email"></span>
          <a id="login-link" href="login.html">Login</a>
          <button id="logout-btn" type="button" style="display:none">Salir</button>
        </div>
    </header>
    <div class="page-logo"><img src="img/logopctch.png" alt="PCT"></div>
    <main>
      <section class="dashboard">
        <div class="cards">
          <div class="card">
            <div class="kpi-label">Inventario</div>
            <div id="kpi-inventario" class="kpi">—</div>
          </div>
          <div class="card">
            <div class="kpi-label">Inspecciones</div>
            <div id="kpi-inspecciones" class="kpi">—</div>
          </div>
          <div class="card">
            <div class="kpi-label">Últimos 7 días</div>
            <div id="kpi-ult7" class="kpi">—</div>
          </div>
          <div class="card">
            <div class="kpi-label">Por vencer 30 días</div>
            <div id="kpi-vencer30" class="kpi">—</div>
          </div>
          <div class="card">
            <div class="kpi-label">Por vencer 60 días</div>
            <div id="kpi-vencer60" class="kpi">—</div>
          </div>
          <div class="card" id="card-storage" style="display:none;">
            <div class="kpi-label">Almacenamiento (estimado)</div>
            <div id="kpi-storage" class="kpi">—</div>
          </div>
        </div>
        <div class="timeline">
          <div class="timeline-header">
            <div class="title">Barra de tiempo</div>
            <div class="legend">
              <span class="dot overdue"></span>Vencidas
              <span class="dot soon7"></span>7 días
              <span class="dot soon30"></span>30 días
              <span class="dot ok"></span>>30 días
            </div>
          </div>
          <div id="timeline-bar" class="timeline-bar"></div>
        </div>
      </section>
    </main>
    
    <footer>
      <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">
        Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle">
      </a>
    </footer> 

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <!-- Your Firebase config: create firebase-config.js from firebase-config.sample.js -->
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script>
  (function(){
    // Service Worker: en localhost desregistrar para evitar caché obsoleta; en producción registrar
    if ('serviceWorker' in navigator) {
      if (/^(localhost|127\.0\.0\.1)$/i.test(location.hostname)) {
        navigator.serviceWorker.getRegistrations().then(function(regs){ regs.forEach(function(r){ r.unregister(); }); }).catch(function(){});
      } else {
        window.addEventListener('load', function(){
          navigator.serviceWorker.register('service-worker.js').catch(function(e){ console.warn('SW reg failed', e); });
        });
      }
    }
    const INVENTARIO_SRC = 'docs/INVENTARIO GENERAL PCT 2025 UNIFICADO.csv';
    function fmt(n){ try { return n.toLocaleString('es-MX'); } catch { return String(n); } }
    function esc(s){ return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    async function countInventario(){
      try{
        const res = await fetch(INVENTARIO_SRC + '?t=' + Date.now(), { cache:'no-store' });
        if (!res.ok) return 0;
        const t = await res.text();
        const lines = t.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
        return Math.max(0, lines.length - 1);
      }catch{ return 0; }
    }
    async function getInspecciones(){
      try{
        // Esperar a que Firebase y Auth estén listos
        let tries = 0;
        while (tries < 60 && (!window.firebase || !window.auth)) { await new Promise(r=>setTimeout(r,50)); tries++; }
        const db = window.db;
        const auth = window.auth;
        if (!db || !auth) return { total:0, last7:0, byEquipo:new Map() };
        // Esperar a usuario autenticado
        const user = auth.currentUser || await new Promise((resolve)=>{
          const unsub = auth.onAuthStateChanged((u)=>{ unsub(); resolve(u||null); });
        });
        if (!user) return { total:0, last7:0, byEquipo:new Map() };
        // Consultar Firestore
        const snap = await db.collection('inspections').orderBy('fechaTs','desc').limit(5000).get();
        const now = Date.now();
        const seven = 7*24*3600*1000;
        let total = snap.size;
        let last7 = 0;
        const byEq = new Map(); // eq -> { ts, cliente }
        snap.forEach(doc=>{
          const d = doc.data()||{};
          const eq = String(d.equipoActivo||'').trim();
          const ts = typeof d.fechaTs==='number' ? d.fechaTs : (d.created_at||0);
          const cliente = String(
            d.cliente || d.clienteNombre || d.clienteNombreRazonSocial || d.clienteRS || ''
          ).trim();
          if (now - ts <= seven) last7++;
          if (eq) {
            const cur = byEq.get(eq);
            if (!cur || ts > cur.ts) byEq.set(eq, { ts, cliente });
          }
        });
        return { total, last7, byEquipo: byEq };
      }catch(e){
        console.warn('Dash getInspecciones err/perms', e);
        return { total:0, last7:0, byEquipo:new Map() };
      }
    }
    function classifyDue(byEquipo){
      const now = Date.now();
      const day = 24*3600*1000;
      const dueMs = 60*day;
      let overdue=0, soon7=0, soon30=0, ok=0;
      const items = [];
      for (const [eq, info] of byEquipo.entries()){
        const ts = typeof info === 'object' && info ? info.ts : info;
        const cliente = typeof info === 'object' && info ? (info.cliente || '') : '';
        const next = ts + dueMs;
        const delta = Math.floor((next - now)/day);
        let status = 'ok';
        if (delta < 0) { status = 'overdue'; overdue++; }
        else if (delta <= 7) { status = 'soon7'; soon7++; }
        else if (delta <= 30) { status = 'soon30'; soon30++; }
        else { ok++; }
        items.push({ eq, cliente, next, delta, status });
      }
      items.sort((a,b)=> a.next - b.next);
      return { overdue, soon7, soon30, ok, items };
    }
    function renderTimeline(items){
      const bar = document.getElementById('timeline-bar');
      if (!bar) return;
      bar.innerHTML = '';
      // Ensure singleton tooltip element INSIDE the bar
      let tip = bar.querySelector('#tl-tooltip');
      if (!tip){
        tip = document.createElement('div');
        tip.id = 'tl-tooltip';
        tip.className = 'tooltip';
        bar.appendChild(tip);
      }
      const now = Date.now();
      const dayMs = 24*3600*1000;
      const start = now - 7*dayMs;
      const end = now + 60*dayMs;
      const range = end - start;

      // --- Markers: today, weeks, and months ---
      // Today marker
      const mToday = document.createElement('div');
      mToday.className = 'tl-marker today';
      mToday.style.left = (Math.max(0, Math.min(1, (now - start)/range)) * 100) + '%';
      bar.appendChild(mToday);

      // Weekly markers (every 7 days from the nearest multiple of 7 after start)
      let wCursor = start - (start % dayMs); // align to midnight
      // shift to next 7-day step from start
      const offsetToNext7 = ((Math.ceil((start - wCursor)/dayMs) + 7) % 7) || 7;
      wCursor = start + offsetToNext7*dayMs;
      for (let t = wCursor; t <= end; t += 7*dayMs) {
        const x = (t - start) / range;
        if (x <= 0 || x >= 1) continue;
        const mk = document.createElement('div');
        mk.className = 'tl-marker week';
        mk.style.left = (x*100) + '%';
        bar.appendChild(mk);
      }

      // Monthly markers: first day of each month within range
      const dStart = new Date(start); dStart.setHours(0,0,0,0);
      const dEnd = new Date(end); dEnd.setHours(0,0,0,0);
      let mCursor = new Date(dStart.getFullYear(), dStart.getMonth()+1, 1);
      while (mCursor.getTime() < dEnd.getTime()) {
        const t = mCursor.getTime();
        const x = (t - start) / range;
        if (x > 0 && x < 1) {
          const mk = document.createElement('div');
          mk.className = 'tl-marker month';
          mk.style.left = (x*100) + '%';
          bar.appendChild(mk);
        }
        mCursor = new Date(mCursor.getFullYear(), mCursor.getMonth()+1, 1);
      }
      // Labels: Hoy, 7 días, 14 días, 1 mes
      const labelPoints = [
        { t: now, text: 'Hoy' },
        { t: now + 7*dayMs, text: '7 días' },
        { t: now + 14*dayMs, text: '14 días' },
        { t: now + 30*dayMs, text: '1 mes' }
      ];
      labelPoints.forEach(lp => {
        const x = (lp.t - start) / range;
        if (x <= 0 || x >= 1) return;
        const el = document.createElement('div');
        el.className = 'tl-label';
        el.textContent = lp.text;
        el.style.left = (x*100) + '%';
        bar.appendChild(el);
      });
      items.forEach(it=>{
        const pos = Math.max(0, Math.min(1, (it.next - start)/range));
        const dot = document.createElement('span');
        dot.className = 'tl-dot ' + it.status;
        dot.style.left = (pos*100) + '%';
        const daysTxt = it.delta < 0 ? `Vencida hace ${Math.abs(it.delta)} días` : `En ${it.delta} días`;
        const clienteTxt = it.cliente ? it.cliente : '—';
        // Custom tooltip events (place centered above the dot)
        const updatePos = ()=>{
          tip.style.left = dot.offsetLeft + 'px';
          tip.style.top = '0px';
        };
        dot.addEventListener('mouseenter', (ev)=>{
          tip.innerHTML = `<div class="title">${esc(it.eq)}</div><div class="muted">Cliente: ${esc(clienteTxt)}</div><div class="muted">Límite: ${esc(daysTxt)}</div>`;
          tip.style.display = 'block';
          updatePos();
        });
        dot.addEventListener('mousemove', updatePos);
        dot.addEventListener('mouseleave', ()=>{ tip.style.display='none'; });
        bar.appendChild(dot);
      });
    }

    async function getStorageEstimate(){
      try{
        if (!('storage' in navigator) || !navigator.storage.estimate) return null;
        const est = await navigator.storage.estimate();
        return est; // {usage, quota}
      }catch{ return null; }
    }
    async function init(){
      const inv = await countInventario();
      const insp = await getInspecciones();
      const due = classifyDue(insp.byEquipo);
      const elInv = document.getElementById('kpi-inventario'); if (elInv) elInv.textContent = fmt(inv);
      const elInsp = document.getElementById('kpi-inspecciones'); if (elInsp) elInsp.textContent = fmt(insp.total);
      const el7 = document.getElementById('kpi-ult7'); if (el7) el7.textContent = fmt(insp.last7);
      const within30 = due.items.filter(it => it.delta >= 0 && it.delta <= 30).length;
      const within60 = due.items.filter(it => it.delta >= 31 && it.delta <= 60).length;
      const elV30 = document.getElementById('kpi-vencer30'); if (elV30) elV30.textContent = fmt(within30);
      const elV60 = document.getElementById('kpi-vencer60'); if (elV60) elV60.textContent = fmt(within60);
      renderTimeline(due.items);
      window.addEventListener('resize', ()=>renderTimeline(due.items));

      // Mostrar almacenamiento estimado solo para admin/director
      try{
        const user = window.auth?.currentUser || null;
        let role = null;
        if (user){
          const tok = await user.getIdTokenResult();
          role = tok?.claims?.role || null;
        }
        if (role === 'admin' || role === 'director'){
          const card = document.getElementById('card-storage');
          if (card) card.style.display = '';
          const est = await getStorageEstimate();
          const elS = document.getElementById('kpi-storage');
          if (est && elS){
            const rawUsed = est.usage || 0;
            const scaledUsed = rawUsed * 10; // multiplicar x10
            const cap = 1024 * 1024 * 1024; // 1 GB fijo
            const shownUsed = Math.min(scaledUsed, cap);
            const shownQuota = cap;
            const pct = Math.round((shownUsed / shownQuota) * 100);
            elS.textContent = `${fmt(Math.round(shownUsed/1024/1024))} MB / ${fmt(Math.round(shownQuota/1024/1024))} MB (${pct}%)`;
          }
        }
      }catch{}
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  })();
  </script>
  <script>
    (function(){
      var v = Date.now();
      document.write('<script src="script.js?v=' + v + '"><\\/script>');
    })();
  </script>
</body>
</html>