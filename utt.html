<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTT - Ultrasonic Thickness Test - PCT</title>
  <meta name="description" content="Prueba de Espesor por Ultrasonido (UTT)">
  <link rel="stylesheet" href="styles.css?v=2025-11-24-1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="img/logo.ico">
  <link rel="shortcut icon" href="img/logo.ico">
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body data-page="utt">
  <header>
    <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
    <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
    <nav id="primary-nav">
      <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li class="nav-dropdown"><details open><summary>Pruebas</summary><ul>
          <li><a href="matestrep.html">MTR Material Test Report</a></li>
          <li><a href="listmatestrep.html">Lista de pruebas (MTR)</a></li>
          <li><a class="active" href="utt.html">Pruebas UTT</a></li>
          <li><a href="listutt.html">Lista UTT</a></li>
          <li><a href="emi.html">Pruebas EMI</a></li>
          <li><a href="listemi.html">Lista EMI</a></li>
          <li><a href="pruebas.html">Pruebas</a></li>
          <li><a href="stockpruebas.html">Stock de pruebas</a></li>
          <li><a href="listapruebas.html">Lista de pruebas</a></li>
        </ul></details></li>
        <li><a href="tareas.html">Tareas</a></li>
        <li class="nav-dropdown"><details><summary>Inspección</summary><ul>
          <li><a href="inspeccion.html">Inspección primaria</a></li>
          <li><a href="reginspecciones.html">Registro de inspecciones</a></li>
        </ul></details></li>
        <li><a href="ingral.html">Inventario</a></li>
        <li class="nav-dropdown"><details><summary>Actividad</summary><ul>
          <li><a href="actividad.html">Registro de actividad</a></li>
          <li><a href="regactividad.html">Historial de registros</a></li>
        </ul></details></li>
        <li><a href="reportes.html">Reportes</a></li>
      </ul>
    </nav>
    <div class="user-box">
      <span id="user-email"></span>
      <a id="login-link" href="login.html">Login</a>
      <button id="logout-btn" type="button" style="display:none">Salir</button>
    </div>
  </header>

  <main class="wide">
    <h1>Ultrasonic Thickness Test (UTT)</h1>
    <div class="page-logo"><img src="img/logopctch.png" alt="PCT"></div>

    <section class="card" style="padding:12px;">
      <div class="meta" style="grid-template-columns: repeat(3, 1fr);">
        <div>
          <div class="label">Equipo/Activo</div>
          <div class="value">
            <input id="utt-eq" class="input" type="text" list="utt-eq-list" placeholder="PCT-..." style="width:220px">
            <datalist id="utt-eq-list"></datalist>
          </div>
        </div>
        <div>
          <div class="label">Método / Norma</div>
          <div class="value"><input id="utt-method" class="input" type="text" placeholder="ASTM A... / API ..." style="width:220px"></div>
        </div>
        <div>
          <div class="label">Usuario</div>
          <div class="value"><span id="utt-user">—</span></div>
        </div>
        <div>
          <div class="label">Espesor nominal (mm)</div>
          <div class="value"><input id="utt-nom" class="input" type="number" step="0.01" min="0" style="width:120px"></div>
        </div>
        <div>
          <div class="label">Tolerancia mínima (mm)</div>
          <div class="value"><input id="utt-tol" class="input" type="number" step="0.01" min="0" style="width:120px"></div>
        </div>
        <div>
          <div class="label">Fecha</div>
          <div class="value"><span id="utt-date">—</span></div>
        </div>
      </div>
    </section>

    <section class="table-wrap">
      <h2>Lecturas</h2>
      <table class="inventory" id="utt-table">
        <thead>
          <tr>
            <th>Punto</th>
            <th>Espesor (mm)</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="utt-body"></tbody>
      </table>
      <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="utt-add" class="btn">Agregar lectura</button>
        <button id="utt-clear" class="btn ghost">Limpiar</button>
      </div>
      <div style="margin-top:8px; display:flex; gap:16px;">
        <div><strong>Min:</strong> <span id="utt-min">—</span> mm</div>
        <div><strong>Promedio:</strong> <span id="utt-avg">—</span> mm</div>
        <div><strong>Conformidad global:</strong> <span id="utt-badge" class="status-badge">—</span></div>
      </div>
    </section>

    <div class="actions">
      <button class="btn-primary" id="utt-save" type="button">Guardar</button>
      <button class="btn" id="utt-print" type="button">Imprimir / PDF</button>
    </div>
  </main>

  <footer>
    <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script src="script.js?v=2025-11-24-1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    const EQ_SRC = 'docs/INVENTARIO GENERAL PCT 2025 UNIFICADO.csv';
    const body = document.getElementById('utt-body');
    const minEl = document.getElementById('utt-min');
    const avgEl = document.getElementById('utt-avg');
    const badge = document.getElementById('utt-badge');
    const tolEl = document.getElementById('utt-tol');
    const eqInput = document.getElementById('utt-eq');

    function fmt(n){ try{return Number(n).toFixed(2);}catch{return String(n);} }
    function setUser(){ try{ const u = window.auth?.currentUser; document.getElementById('utt-user').textContent = u?.email || '—'; }catch{} }
    function setDate(){ const d = new Date(); const pad=n=>String(n).padStart(2,'0'); document.getElementById('utt-date').textContent = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

    function recompute(){
      const rows = Array.from(body.querySelectorAll('tr'));
      const vals = [];
      const tol = parseFloat(tolEl.value||'');
      rows.forEach(tr=>{
        const v = parseFloat(tr.querySelector('input')?.value||'');
        const st = tr.querySelector('.state');
        if (!isNaN(v)){
          vals.push(v);
          if (!isNaN(tol)){
            const ok = v >= tol; st.textContent = ok ? 'OK' : 'BAJO'; st.className = 'state ' + (ok ? 'ok' : 'bad');
          } else { st.textContent = '—'; st.className = 'state'; }
        } else { st.textContent = '—'; st.className = 'state'; }
      });
      if (!vals.length){ minEl.textContent='—'; avgEl.textContent='—'; badge.textContent='—'; badge.className='status-badge'; return; }
      const min = Math.min(...vals); const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      minEl.textContent = fmt(min); avgEl.textContent = fmt(avg);
      const tol2 = parseFloat(tolEl.value||'');
      if (!isNaN(tol2)){
        const ok = min >= tol2; badge.textContent = ok ? 'Conforme' : 'No conforme'; badge.className = 'status-badge ' + (ok ? 'ok' : 'bad');
      } else { badge.textContent='—'; badge.className='status-badge'; }
    }

    function addRow(){
      const tr = document.createElement('tr');
      const idx = body.children.length + 1;
      tr.innerHTML = `<td>P${idx}</td><td><input type="number" step=\"0.01\" min=\"0\" class=\"input\" style=\"width:110px\"></td><td class=\"state\">—</td><td><button class=\"btn ghost del\">✕</button></td>`;
      body.appendChild(tr);
      const inp = tr.querySelector('input'); inp.addEventListener('input', recompute);
      tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); recompute(); });
    }

    function clearAll(){ body.innerHTML=''; minEl.textContent='—'; avgEl.textContent='—'; badge.textContent='—'; badge.className='status-badge'; }

    function loadEquipos(){
      Papa.parse(EQ_SRC, { download:true, skipEmptyLines:true, complete: (res)=>{
        const data = res?.data || []; if (!data.length) return;
        const headers = data[0]||[]; const rows = data.slice(1);
        const idx = headers.findIndex(h=>/EQUIPO\s*\/\s*ACTIVO|EQUIPO\s*ACTIVO|EQUIPO/i.test(String(h)));
        const dl = document.getElementById('utt-eq-list');
        const set = new Set();
        rows.forEach(r=>{ const v = String(r[idx]||'').trim(); if (/^PCT\-/.test(v)) set.add(v); });
        dl.innerHTML = Array.from(set).sort().map(v=>`<option value="${v}"></option>`).join('');
      }});
    }

    document.getElementById('utt-add').addEventListener('click', addRow);
    document.getElementById('utt-clear').addEventListener('click', clearAll);
    tolEl.addEventListener('input', recompute);

    async function saveToFirestore(){
      const KEY='utt_pending_saves';
      let payload;
      try{
        const equipo = (document.getElementById('utt-eq').value||'').trim();
        const metodo = (document.getElementById('utt-method').value||'').trim();
        const user = (window.auth?.currentUser?.email)||'';
        const fechaText = document.getElementById('utt-date').textContent||'';
        const nominal = parseFloat(document.getElementById('utt-nom').value||'');
        const tol = parseFloat(document.getElementById('utt-tol').value||'');
        const lecturas = Array.from(body.querySelectorAll('tr')).map((tr,i)=>{
          const v = parseFloat(tr.querySelector('input')?.value||'');
          return { punto: `P${i+1}`, espesor: isNaN(v)? null : v };
        });
        const vals = lecturas.map(x=>x.espesor).filter(v=> typeof v==='number');
        const min = vals.length? Math.min(...vals) : null;
        const avg = vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        const conforme = (min!=null && !isNaN(tol)) ? (min >= tol) : null;
        payload = {
          equipo, metodo, user,
          fechaTexto: fechaText,
          fechaISO: new Date().toISOString(),
          nominal: isNaN(nominal)? null : nominal,
          tolerancia: isNaN(tol)? null : tol,
          min: min==null? null : Number(min.toFixed(2)),
          promedio: avg==null? null : Number(avg.toFixed(2)),
          conformidad: conforme==null? '—' : (conforme? 'Conforme' : 'No conforme'),
          estado: conforme===false? 'INACTIVO' : 'ACTIVO',
          lecturas,
          createdAt: (window.firebase?.firestore?.FieldValue?.serverTimestamp?.())||null
        };
        const btn = document.getElementById('utt-save'); if (btn){ btn.disabled=true; btn.textContent='Guardando...'; }
        if (!window.firebase || !window.firebase.firestore){ throw new Error('Firebase no disponible'); }
        const db = window.firebase.firestore();
        const docRef = await db.collection('utt_tests').add(payload);
        if (btn){ btn.disabled=false; btn.textContent='Guardar'; }
        alert('Guardado UTT exitoso. ID: ' + docRef.id);
      }catch(err){
        console.error('Error guardando UTT', err);
        try{ const list=JSON.parse(localStorage.getItem(KEY)||'[]'); if(payload){ list.push({when:Date.now(), data: payload}); } localStorage.setItem(KEY, JSON.stringify(list)); }catch{}
        alert('No se pudo guardar en Firestore. Revisa conexión.');
        const btn = document.getElementById('utt-save'); if (btn){ btn.disabled=false; btn.textContent='Guardar'; }
      }
    }
    document.getElementById('utt-save').addEventListener('click', saveToFirestore);
    document.getElementById('utt-print').addEventListener('click', ()=>{ window.print(); });

    async function flushPending(){
      const KEY='utt_pending_saves';
      try{
        if (!window.navigator.onLine) return;
        if (!window.firebase || !window.firebase.firestore) return;
        const db = window.firebase.firestore();
        const list = JSON.parse(localStorage.getItem(KEY)||'[]');
        if (!Array.isArray(list) || !list.length) return;
        const remain=[];
        for (const item of list){
          try{ const toSend=item?.data; if(!toSend) continue; await db.collection('utt_tests').add(toSend); }
          catch(e){ remain.push(item); }
        }
        if (remain.length){ localStorage.setItem(KEY, JSON.stringify(remain)); }
        else { localStorage.removeItem(KEY); }
      }catch(e){ console.warn('flushPending UTT falló', e); }
    }
    window.addEventListener('online', flushPending);

    // intentar enviar pendientes al iniciar
    flushPending();
    setUser(); setDate(); loadEquipos(); addRow(); addRow();
  })();
  </script>
</body>
</html>
