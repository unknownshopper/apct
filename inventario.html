<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario General - PCT</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Gestión del inventario general de equipos y activos del sistema PCT.">
  <meta name="author" content="PCT">
  <link rel="canonical" href="https://pc-t.mx/inventario.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pc-t.mx/inventario.html">
  <meta property="og:title" content="Inventario General - PCT">
  <meta property="og:description" content="Gestión del inventario general de equipos y activos del sistema PCT.">
  <meta property="og:site_name" content="PCT">
  
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="img/logo.ico">
  <link rel="shortcut icon" href="img/logo.ico">
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff">
</head>
<body data-page="inventario">
  <header>
    <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
    <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
    <nav id="primary-nav">
      <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li class="nav-dropdown"><details><summary>Pruebas</summary><ul>
          <li><a href="matestrep.html">MTR Material Test Report</a></li>
          <li><a href="listmatestrep.html">Lista de pruebas (MTR)</a></li>
          <li><a href="pruebas.html">Pruebas PND (pruebas no destructibles)</a></li>
          <li><a href="stockpruebas.html">PND x equipo</a></li>
          <li><a href="listapruebas.html">Registro PND</a></li>
          <li><a href="utt.html">Pruebas UTT</a></li>
          <li><a href="listutt.html">Lista UTT</a></li>
          <li><a href="emi.html">Pruebas EMI</a></li>
          <li><a href="listemi.html">Lista EMI</a></li>
        </ul></details></li>
        <li><a href="tareas.html">Tareas</a></li>
        <li><a href="inspeccion.html">Inspección</a></li>
        <li><a class="active" href="inventario.html">Inventario</a></li>
        <li><a href="actividad.html">Actividad</a></li>
        <li><a href="reportes.html">Reportes</a></li>
      </ul>
    </nav>
    <div class="user-box">
      <span id="user-email"></span>
      <a id="login-link" href="login.html">Login</a>
      <button id="logout-btn" type="button" style="display:none">Salir</button>
    </div>
  </header>
  <main class="wide">
    <h1>Inventario General</h1>
    <div class="page-logo"><img src="img/logopctch.png" alt="PCT"></div>

    <div class="toolbar" role="region" aria-label="Herramientas de tabla">
      <div class="group">
        <input id="q" type="text" placeholder="Buscar..." aria-label="Buscar" />
        <button id="clearQ" class="btn-primary" type="button">Limpiar</button>
        <button id="btnGenSerials" class="btn-primary" type="button">Generar seriales faltantes</button>
        <button id="btnExportCSV" class="btn-primary" type="button" style="display:none;">Descargar CSV actualizado</button>
      </div>
      <div class="toolbar-count" id="count">0 registros</div>
    </div>

    <div id="inventory-wrapper" class="table-responsive" aria-live="polite">
      <div class="scrollbar-x"><div class="scrollbar-content"></div></div>
      <div class="table-scroll">
        <table class="inventory" id="invTable" aria-describedby="count">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>
  <footer>
    <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    const SRC = 'docs/INVENTARIO GENERAL PCT 2025 UNIFICADO.csv';
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const q = document.getElementById('q');
    const clearQ = document.getElementById('clearQ');
    const count = document.getElementById('count');
    const table = document.getElementById('invTable');

    let rows = [];
    let headers = [];
    let view = [];
    let sortCol = -1;
    let sortDir = 'asc';

    function fmt(n){ return n.toLocaleString('es-MX'); }

    function renderHead(){
      const tr = document.createElement('tr');
      const heads = headers;
      heads.forEach((h, idx)=>{
        const th = document.createElement('th');
        th.textContent = h;
        th.setAttribute('role','button');
        th.tabIndex = 0;
        th.dataset.index = String(idx);
        if (idx === sortCol) th.dataset.sort = sortDir;
        th.addEventListener('click', ()=>toggleSort(idx));
        th.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); toggleSort(idx); } });
        tr.appendChild(th);
      });
      thead.innerHTML = '';
      thead.appendChild(tr);
    }

    function renderBody(data){
      const frag = document.createDocumentFragment();
      for (let i=0;i<data.length;i++){
        const tr = document.createElement('tr');
        const row = data[i];
        for (let j=0;j<headers.length;j++){
          const td = document.createElement('td');
          const colName = headers[j];
          const v = row[j] == null ? '' : row[j];
          if (colName === 'EDO'){
            const btn = document.createElement('button');
            btn.textContent = String(v||'').trim() || 'ON';
            btn.className = 'btn-secondary';
            btn.style.padding = '2px 8px';
            btn.style.fontSize = '12px';
            btn.onclick = ()=>{
              const cur = String(row[j]||'').trim().toUpperCase();
              const next = (cur === 'ON') ? 'OFF' : 'ON';
              row[j] = next;
              btn.textContent = next;
              // Mostrar botón de exportación
              const ex = document.getElementById('btnExportCSV');
              if (ex) ex.style.display = '';
            };
            td.appendChild(btn);
          } else {
            td.textContent = v;
          }
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);
      count.textContent = fmt(data.length) + ' registros';
      syncScrollbar();
    }

    function applyFilter(){
      const term = (q.value||'').trim().toLowerCase();
      if (!term){ view = rows; } else {
        view = rows.filter(r => r.some(c => String(c||'').toLowerCase().includes(term)));
      }
      if (sortCol>=0) applySort();
      renderBody(view);
    }

    function toggleSort(col){
      if (sortCol === col){ sortDir = (sortDir==='asc'?'desc':'asc'); }
      else { sortCol = col; sortDir = 'asc'; }
      applySort();
      renderHead();
      renderBody(view);
    }

    function applySort(){
      const dir = sortDir === 'asc' ? 1 : -1;
      view = [...view].sort((a,b)=>{
        const av = a[sortCol] ?? '';
        const bv = b[sortCol] ?? '';
        const an = parseFloat(String(av).replace(/,/g,''));
        const bn = parseFloat(String(bv).replace(/,/g,''));
        const bothNum = !isNaN(an) && !isNaN(bn);
        if (bothNum) return (an>bn?1:an<bn?-1:0)*dir;
        return String(av).localeCompare(String(bv), 'es', { sensitivity:'base' }) * dir;
      });
    }

    function syncScrollbar(){
      const scroller = document.querySelector('.table-scroll');
      const bar = document.querySelector('.scrollbar-x');
      const content = bar.querySelector('.scrollbar-content');
      content.style.width = table.scrollWidth + 'px';
      bar.scrollLeft = scroller.scrollLeft;
      bar.onscroll = () => { scroller.scrollLeft = bar.scrollLeft; };
      scroller.onscroll = () => { bar.scrollLeft = scroller.scrollLeft; };
      let dragging = false; let startX=0; let startLeft=0;
      bar.addEventListener('mousedown', (e)=>{ dragging=true; startX=e.clientX; startLeft=bar.scrollLeft; document.getElementById('inventory-wrapper').classList.add('dragging'); });
      window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-startX; bar.scrollLeft = startLeft + dx; });
      window.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; document.getElementById('inventory-wrapper').classList.remove('dragging'); }});
    }

    function normalizeHeader(h){
      return String(h||'').trim();
    }

    function load(){
      Papa.parse(SRC, {
        download: true,
        skipEmptyLines: 'greedy',
        complete: (res)=>{
          const data = res.data || [];
          if (!data.length){ headers=[]; rows=[]; view=[]; renderHead(); renderBody([]); return; }
          headers = data[0].map(normalizeHeader);
          rows = data.slice(1);
          view = rows;
          renderHead();
          renderBody(view);
        }
      });
    }

    function familyFrom(row){
      const eq = String(row[headers.indexOf('EQUIPO / ACTIVO')]||'').toUpperCase();
      const prod = String(row[headers.indexOf('PRODUCTO')]||'').toUpperCase();
      if (/\bXO\b|CROSS\s*OVER|XO API/i.test(prod+eq)) return 'XO';
      if (/CARRETE ADAPTADOR/i.test(prod+eq)) return 'CA';
      if (/CARRETE ESPACIADOR/i.test(prod+eq)) return 'CE';
      if (/BRIDA ADAPTADORA/i.test(prod+eq)) return 'DSA';
      if (/BRIDA DE PRUEBA/i.test(prod+eq)) return 'BP';
      if (/CARRETE DE CONTROL/i.test(prod+eq)) return 'CC';
      return 'OT';
    }

    function toInch(n){ const x = parseFloat(String(n).replace(',', '.')); if (isNaN(x)) return null; return Math.round(x); }
    function sideCode(row, side){
      const dIdx = headers.indexOf(side===1?'DIAMETRO 1':'DIAMETRO 2');
      const tIdx = headers.indexOf(side===1?'TIPO 1':'TIPO 2');
      const cIdx = headers.indexOf(side===1?'CONEXIÓN 1':'CONEXIÓN 2');
      const pIdx = headers.indexOf(side===1?'PRESION 1':'PRESION 2');
      const dia = toInch(row[dIdx]);
      const tipo = String(row[tIdx]||'').toUpperCase();
      const conx = String(row[cIdx]||'').toUpperCase();
      const pres = String(row[pIdx]||'').toUpperCase();
      let letter = 'X';
      if (/FLANGE|FLG|R-\d+|BX-\d+|RX-\d+/i.test(tipo+conx)) letter = 'F';
      else if (/(^|\b)(1502|602|206)(\b|$)/.test(conx)) letter = 'W';
      else if (/NPT/.test(conx)) letter = 'N';
      else if (/H\b|HEMBRA/.test(conx)) letter = 'F';
      else if (/M\b|MACHO/.test(conx)) letter = 'M';
      const d = dia!=null? String(dia):'';
      return d+letter;
    }

    function buildConn(row){
      const a = sideCode(row,1), b = sideCode(row,2);
      return (a||'') + '/' + (b||'');
    }

    function computeExistingSequences(){
      const seqMap = new Map(); // key: fam|conn -> max
      const sIdx = headers.indexOf('SERIAL');
      for (const r of rows){
        const s = String(r[sIdx]||'');
        const m = s.match(/^PCT-(\d+|XX|00)-([A-Z]{2,3})-([0-9A-Z/]+)-(\d{3})$/);
        if (!m) continue;
        const fam = m[2]; const conn = m[3]; const n = parseInt(m[4],10)||0;
        const key = fam+'|'+conn;
        seqMap.set(key, Math.max(seqMap.get(key)||0, n));
      }
      return seqMap;
    }

    function generateSerials(){
      const sIdx = headers.indexOf('SERIAL');
      const seq = computeExistingSequences();
      const medidaFrom = (r)=>{
        const dIdx = headers.indexOf('DIAMETRO 1');
        const val = toInch(r[dIdx]);
        return (val==null? '00' : String(val));
      };
      let changed = 0;
      for (const r of rows){
        const cur = String(r[sIdx]||'').trim();
        if (cur) { continue; }
        const fam = familyFrom(r);
        const conn = buildConn(r).replace(/\s+/g,'');
        const key = fam+'|'+conn;
        const next = (seq.get(key)||0)+1; seq.set(key, next);
        const seqStr = String(next).padStart(3,'0');
        const serial = `PCT-${medidaFrom(r)}-${fam}-${conn}-${seqStr}`;
        r[sIdx] = serial;
        changed++;
      }
      renderHead(); renderBody(view);
      const btn = document.getElementById('btnExportCSV');
      btn.style.display = changed>0 ? '' : 'none';
    }

    function exportUpdatedCSV(){
      const sIdx = headers.indexOf('SERIAL');
      const out = [headers, ...rows];
      const csv = Papa.unparse(out);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'INVENTARIO GENERAL PCT 2025 UNIFICADO.csv';
      a.click();
    }

    q.addEventListener('input', applyFilter);
    clearQ.addEventListener('click', ()=>{ q.value=''; applyFilter(); q.focus(); });

    document.addEventListener('DOMContentLoaded', load);
    document.getElementById('btnGenSerials').addEventListener('click', generateSerials);
    document.getElementById('btnExportCSV').addEventListener('click', exportUpdatedCSV);
  })();
  </script>
</body>
</html>
