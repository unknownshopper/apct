<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crear Prueba</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .form-field { display: flex; flex-direction: column; gap: 6px; }
      .form-field label { font-size: 12px; color: #374151; }
      .form-field input { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; }
      @media (max-width: 640px){ .form-grid { grid-template-columns: 1fr; } }
      .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
      .toolbar .group { display:flex; gap:8px; align-items:center; }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
      <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
      <nav id="primary-nav">
        <ul>
          <li><a href="index.html">Dashboard</a></li>
          <li class="nav-dropdown"><details><summary>Pruebas</summary><ul>
            <li><a class="active" href="pruebas.html">Pruebas</a></li>
            <li><a href="stockpruebas.html">Stock de pruebas</a></li>
            <li><a href="listapruebas.html">Lista de pruebas</a></li>
          </ul></details></li>
          <li><a href="tareas.html">Tareas</a></li>
          <li><a href="inspeccion.html">Inspección</a></li>
          <li><a href="ingral.html">Inventario</a></li>
          <li><a href="actividad.html">Actividad</a></li>
          <li><a href="reportes.html">Reportes</a></li>
        </ul>
      </nav>
      <div class="user-box">
        <span id="user-email"></span>
        <a id="login-link" href="login.html">Login</a>
        <button id="logout-btn" type="button" style="display:none">Salir</button>
      </div>
    </header>
    <main class="wide">
      <h1 style="margin-bottom: 1rem;">Crear Prueba</h1>
      <div class="toolbar">
        <div class="group">
          <a class="btn-primary" href="listapruebas.html">Ver pruebas</a>
        </div>
        <div id="status" class="toolbar-count"></div>
      </div>
      <form id="prueba-form">
        <div id="form-fields" class="form-grid"></div>
        <div style="margin-top:1rem; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" id="btn-cancel">Cancelar</button>
          <button type="button" class="btn-primary" id="btn-save">Guardar</button>
        </div>
      </form>
    </main>
    <footer></footer>

    <script>
      (function(){
        const CSV_URL = 'docs/inventario.csv';
        let HEADERS = [];
        let ALL_ROWS = [];
        let EQUIPO_IDX = -1;

        function parseCSV(text){
          const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.length);
          const rows = lines.map(line=>{
            const out = []; const regex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",]*))/g; let m;
            while ((m = regex.exec(line)) !== null) {
              let v = m[1] !== undefined ? m[1].replace(/""/g,'"') : m[2];
              out.push(v ?? '');
            }
            return out;
          });
          return rows;
        }

        function headerIndexByVariants(variantList){
          const norm = (s)=> String(s||'').toUpperCase();
          const headersNorm = HEADERS.map(h=>norm(h));
          for (const v of variantList){
            const idx = headersNorm.indexOf(norm(v));
            if (idx>=0) return idx;
          }
          return -1;
        }

        function safeEscapeAttr(v){
          try { return CSS && typeof CSS.escape==='function' ? CSS.escape(v) : String(v).replace(/"/g,'\\"'); } catch { return String(v).replace(/"/g,'\\"'); }
        }
        function getInputByHeader(headerName){
          const sel = `input[name="${safeEscapeAttr(headerName)}"]`;
          return document.querySelector(sel);
        }

        function autofillFromEquipo(value){
          const val = String(value||'').trim(); if (!val || EQUIPO_IDX<0) return;
          // Normalizar y buscar la primera coincidencia (case-insensitive)
          const norm = (s)=> String(s||'').trim().toUpperCase();
          const row = ALL_ROWS.find(r => norm(r[EQUIPO_IDX]) === norm(val));
          if (!row) return;
          // índices de columnas a popular
          const idxProducto = headerIndexByVariants(['PRODUCTO']);
          const idxDesc = headerIndexByVariants(['DESCRIPCION','DESCRIPCIÓN']);
          const idxPrueba = headerIndexByVariants(['PRUEBA / CALIBRACION','PRUEBA/CALIBRACION','PRUEBA / CALIBRACIÓN','PRUEBA/CALIBRACIÓN']);
          const idxTipo = headerIndexByVariants(['TIPO EQUIPO']);
          const idxArea = headerIndexByVariants(['ÁREA A INSPECIONAR','AREA A INSPECIONAR']);
          // asignar a inputs si existen
          function setIf(idx, header){
            if (idx>=0){ const inp = getInputByHeader(header); if (inp){ inp.value = String(row[idx]||''); } }
          }
          if (idxProducto>=0) setIf(idxProducto, HEADERS[idxProducto]);
          if (idxDesc>=0) setIf(idxDesc, HEADERS[idxDesc]);
          if (idxPrueba>=0) setIf(idxPrueba, HEADERS[idxPrueba]);
          if (idxTipo>=0) setIf(idxTipo, HEADERS[idxTipo]);
          if (idxArea>=0) setIf(idxArea, HEADERS[idxArea]);
        }

        function ensureDatalist(id, opts){
          let dl = document.getElementById(id);
          if (!dl){ dl = document.createElement('datalist'); dl.id = id; document.body.appendChild(dl); }
          dl.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const v of opts){ const o = document.createElement('option'); o.value = v; frag.appendChild(o); }
          dl.appendChild(frag);
          return dl;
        }

        function buildForm(){
          const host = document.getElementById('form-fields');
          host.innerHTML = '';
          for (const h of HEADERS){
            const labelText = String(h||'').trim();
            const wrap = document.createElement('div'); wrap.className = 'form-field';
            const label = document.createElement('label'); label.textContent = labelText; label.htmlFor = 'fld-' + btoa(labelText).replace(/[^a-z0-9]/gi,'');
            const input = document.createElement('input'); input.type='text'; input.id=label.htmlFor; input.name=labelText; input.placeholder=labelText;
            const norm = labelText.toUpperCase().replace(/\s*\/\s*/g,'/');
            const isEquipo = /^(EQUIPO\/ACTIVO|EQUIPO\s*ACTIVO|EQUIPO)$/.test(norm) || labelText.trim().toUpperCase()==='EQUIPO / ACTIVO';
            if (isEquipo){
              // Construir opciones desde ALL_ROWS y EQUIPO_IDX
              if (EQUIPO_IDX >= 0 && ALL_ROWS.length){
                const set = new Set();
                for (const r of ALL_ROWS){ const v = String(r[EQUIPO_IDX]||'').trim(); if (v) set.add(v); }
                const opts = Array.from(set).sort((a,b)=>a.localeCompare(b));
                ensureDatalist('dl-inventory-equipos', opts);
                input.setAttribute('list','dl-inventory-equipos');
                input.placeholder = 'Equipo/Activo (inventario)';
              }
              // Auto-popular campos relacionados al cambiar selección
              const trigger = ()=> autofillFromEquipo(input.value||'');
              input.addEventListener('input', trigger);
              input.addEventListener('change', trigger);
            }
            wrap.appendChild(label); wrap.appendChild(input); host.appendChild(wrap);
          }
          // Si ya hay un valor prellenado en EQUIPO/ACTIVO, disparar autofill
          const equipoHeader = HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|^EQUIPO\s*ACTIVO$|^EQUIPO$/i.test(String(h).replace(/\s*\/\s*/g,'/')) || String(h).trim().toUpperCase()==='EQUIPO / ACTIVO');
          const eqInput = equipoHeader ? getInputByHeader(equipoHeader) : null;
          if (eqInput && eqInput.value) autofillFromEquipo(eqInput.value);
        }

        async function loadHeaders(){
          try{
            const res = await fetch(CSV_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error('No se pudo cargar el CSV');
            const txt = await res.text();
            const rows = parseCSV(txt);
            if (!rows.length) throw new Error('CSV vacío');
            HEADERS = rows[0].slice();
            ALL_ROWS = rows.slice(1);
            // localizar índice de EQUIPO / ACTIVO (con variantes)
            const norm = (s)=> String(s||'').toUpperCase().replace(/\s*\/\s*/g,'/');
            const variants = new Set(['EQUIPO/ACTIVO','EQUIPO ACTIVO','EQUIPO']);
            for (let i=0;i<HEADERS.length;i++){
              const h = HEADERS[i];
              const H = norm(h);
              if (H==='EQUIPO/ACTIVO' || variants.has(H)) { EQUIPO_IDX = i; break; }
            }
            buildForm();
          }catch(err){
            console.error(err);
            document.getElementById('status').textContent = 'Error cargando encabezados';
          }
        }

        function getCurrentUser(){
          try { return firebase?.auth?.().currentUser || null; } catch { return null; }
        }

        async function savePrueba(){
          const btn = document.getElementById('btn-save'); btn.disabled = true;
          const status = document.getElementById('status'); status.textContent = 'Guardando...';
          const form = document.getElementById('prueba-form');
          const data = {};
          form.querySelectorAll('input').forEach(inp => { data[inp.name||''] = inp.value || ''; });
          try{
            const user = getCurrentUser();
            if (!user){ status.textContent = 'Debes iniciar sesión para guardar'; alert('Inicia sesión para crear pruebas'); btn.disabled = false; return; }
            const payload = {
              headers: HEADERS,
              data,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: user?.email || ''
            };
            await window.db.collection('pruebas').add(payload);
            status.textContent = 'Guardado';
            alert('Prueba creada');
            form.reset();
          }catch(err){
            console.error(err);
            status.textContent = 'Error al guardar';
            alert('Ocurrió un error al guardar');
          } finally {
            btn.disabled = false;
          }
        }

        function init(){
          loadHeaders();
          const status = document.getElementById('status');
          const saveBtn = document.getElementById('btn-save');
          const userSpan = document.getElementById('user-email');
          const loginLink = document.getElementById('login-link');
          const logoutBtn = document.getElementById('logout-btn');

          try {
            firebase.auth().onAuthStateChanged(u=>{
              if (u){
                userSpan.textContent = u.email || '';
                status.textContent = 'Usuario: ' + (u.email||'');
                saveBtn.disabled = false;
                if (logoutBtn) logoutBtn.style.display = '';
                if (loginLink) loginLink.style.display = 'none';
              } else {
                userSpan.textContent = '';
                status.textContent = 'No autenticado';
                saveBtn.disabled = true;
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (loginLink) loginLink.style.display = '';
              }
            });
            logoutBtn?.addEventListener('click', async ()=>{
              try { await firebase.auth().signOut(); window.location.href = 'login.html'; }
              catch(e){ console.error(e); alert('No se pudo cerrar sesión'); }
            });
          } catch {}

          document.getElementById('btn-save').addEventListener('click', savePrueba);
          document.getElementById('btn-cancel').addEventListener('click', ()=>{ window.location.href = 'listapruebas.html'; });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
      })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
  </body>
</html>
