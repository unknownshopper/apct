<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pruebas PND (pruebas no destructibles) - PCT</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Sistema de creación y gestión de pruebas PCT.">
    <meta name="author" content="PCT">
    <link rel="canonical" href="https://pc-t.mx/pruebas.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pc-t.mx/pruebas.html">
    <meta property="og:title" content="Pruebas PND (pruebas no destructibles) - PCT">
    <meta property="og:description" content="Sistema de creación y gestión de pruebas PCT.">
    <meta property="og:site_name" content="PCT">
    
    <link rel="icon" type="image/x-icon" href="img/logo.ico">
    <link rel="shortcut icon" href="img/logo.ico">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .form-field { display: flex; flex-direction: column; gap: 6px; }
      .form-field label { font-size: 12px; color: #374151; }
      .form-field input, .form-field select, .form-field textarea { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; }
      .form-field textarea { min-height: 100px; resize: vertical; }
      @media (max-width: 640px){ .form-grid { grid-template-columns: 1fr; } }
      .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
      .toolbar .group { display:flex; gap:8px; align-items:center; }
      .page-header { margin-bottom: .5rem; }
      .page-sub { color:#6b7280; font-size:14px; margin:0 0 1rem; }
      .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; background:#fff; }
      .section-title { font-size:14px; color:#374151; margin:0 0 8px; font-weight:600; }
      .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      @media (max-width: 640px){ .two-col { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
      <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
      <nav id="primary-nav">
        <ul>
          <li><a href="index.html">Dashboard</a></li>
          <li class="nav-dropdown"><details><summary>Actividad</summary><ul>
            <li><a href="actividad.html">Registro de actividad</a></li>
            <li><a href="regactividad.html">Historial de registros</a></li>
          </ul></details></li>
          <li class="nav-dropdown"><details><summary>Pruebas</summary><ul>
            <li><a class="active" href="pruebas.html">PND (pruebas no destructivas)</a></li>
            <li><a href="listapruebas.html">Registro PND</a></li>
          </ul></details></li>
          <li><a href="inspeccion.html">Inspección</a></li>
          <li><a href="tareas.html">Tareas</a></li>
          <li><a href="reportes.html">Reportes</a></li>
        </ul>
      </nav>
      <div class="user-box">
        <span id="user-email"></span>
        <a id="login-link" href="login.html">Login</a>
        <button id="logout-btn" type="button" style="display:none">Salir</button>
      </div>
    </header>
    <main class="wide">
      <div class="page-header">
        <h1 style="margin-bottom: .25rem;">PND (pruebas no destructivas)</h1>
        <p class="page-sub">Completa los datos de la prueba. Puedes seleccionar un equipo del inventario para autocompletar información relacionada.</p>
      </div>
      <div class="toolbar">
        <div class="group">
          <a class="btn-primary" href="listapruebas.html">Ver Registro PND</a>
        </div>
        <div id="status" class="toolbar-count"></div>
      </div>
      <form id="prueba-form">
        <div class="card">
          <p class="section-title">Datos de la prueba</p>
          <div class="two-col">
            <div class="form-field">
              <label for="fld-fecha-prueba">Fecha de prueba</label>
              <input type="date" id="fld-fecha-prueba" name="Fecha de prueba" />
            </div>
            <div class="form-field">
              <label for="fld-resultado">Resultado</label>
              <select id="fld-resultado" name="Resultado">
                <option value="">Selecciona...</option>
                <option value="APROBADO">APROBADO</option>
                <option value="RECHAZADO">RECHAZADO</option>
                <option value="OBSERVADO">OBSERVADO</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <p class="section-title">Información desde inventario</p>
        <div id="form-fields" class="form-grid"></div>
        </div>
        <div class="card">
          <p class="section-title">Observaciones</p>
          <div class="form-field">
            <label for="fld-observaciones">Observaciones</label>
            <textarea id="fld-observaciones" name="Observaciones" placeholder="Notas, condiciones de ensayo, evidencias, etc."></textarea>
          </div>
        </div>
        <div style="margin-top:1rem; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" id="btn-cancel">Cancelar</button>
          <button type="button" class="btn-primary" id="btn-save">Guardar</button>
        </div>
      </form>
    </main>
  <footer>
    <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">
      Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle">
    </a>
  </footer>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      (function(){
        const CSV_URL = 'docs/invpnd.csv';
        let HEADERS = [];
        let ALL_ROWS = [];
        let EQUIPO_IDX = -1;

        function parseCSV(text){
          const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.length);
          const rows = lines.map(line=>{
            const out = []; const regex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",]*))/g; let m;
            while ((m = regex.exec(line)) !== null) {
              let v = m[1] !== undefined ? m[1].replace(/""/g,'"') : m[2];
              out.push(v ?? '');
            }
            return out;
          });
          return rows;
        }

        function headerIndexByVariants(variantList){
          const norm = (s)=> String(s||'').toUpperCase();
          const headersNorm = HEADERS.map(h=>norm(h));
          for (const v of variantList){
            const idx = headersNorm.indexOf(norm(v));
            if (idx>=0) return idx;
          }
          return -1;
        }

        function safeEscapeAttr(v){
          try { return CSS && typeof CSS.escape==='function' ? CSS.escape(v) : String(v).replace(/"/g,'\\"'); } catch { return String(v).replace(/"/g,'\\"'); }
        }
        function getInputByHeader(headerName){
          const sel = `input[name="${safeEscapeAttr(headerName)}"]`;
          return document.querySelector(sel);
        }

        function attachDMYMask(input){
          if (!input) return;
          input.addEventListener('input', (e)=>{
            let value = e.target.value.replace(/\D/g,'');
            if (value.length>6) value = value.slice(0,6);
            let f='';
            if (value.length>=1) f += value.slice(0,2);
            if (value.length>=3) f += '/' + value.slice(2,4);
            if (value.length>=5) f += '/' + value.slice(4,6);
            e.target.value = f;
          });
        }

        function autofillFromEquipo(value){
          const val = String(value||'').trim(); if (!val || EQUIPO_IDX<0) return;
          // Normalizar y buscar la primera coincidencia (case-insensitive)
          const norm = (s)=> String(s||'').trim().toUpperCase();
          const row = ALL_ROWS.find(r => norm(r[EQUIPO_IDX]) === norm(val));
          if (!row) return;
          // índices de columnas a popular
          const idxProducto = headerIndexByVariants(['PRODUCTO']);
          const idxDesc = headerIndexByVariants(['DESCRIPCION','DESCRIPCIÓN']);
          const idxPrueba = headerIndexByVariants(['PRUEBA / CALIBRACION','PRUEBA/CALIBRACION','PRUEBA / CALIBRACIÓN','PRUEBA/CALIBRACIÓN']);
          const idxTipo = headerIndexByVariants(['TIPO EQUIPO']);
          const idxArea = headerIndexByVariants(['ÁREA A INSPECIONAR','AREA A INSPECIONAR']);
          const idxSerial = headerIndexByVariants(['SERIAL']);
          const idxEdoGen = headerIndexByVariants(['EDO_GENERAL','EDO']);
          const idxEstadoHeader = headerIndexByVariants(['ESTADO']);
          const idxProp = headerIndexByVariants(['PROPIEDAD']);
          const idxCert = headerIndexByVariants(['NO. DE REPORTE / CERTIFICADO','NO. DE REPORTE/CERTIFICADO','NO DE REPORTE / CERTIFICADO','NO DE REPORTE/CERTIFICADO']);
          // asignar a inputs si existen
          function setIf(idx, header){
            if (idx>=0){ const inp = getInputByHeader(header); if (inp){ inp.value = String(row[idx]||''); } }
          }
          if (idxProducto>=0) setIf(idxProducto, HEADERS[idxProducto]);
          if (idxDesc>=0) setIf(idxDesc, HEADERS[idxDesc]);
          if (idxPrueba>=0) setIf(idxPrueba, HEADERS[idxPrueba]);
          if (idxTipo>=0) setIf(idxTipo, HEADERS[idxTipo]);
          if (idxArea>=0) setIf(idxArea, HEADERS[idxArea]);
          if (idxSerial>=0) setIf(idxSerial, HEADERS[idxSerial]);
          // EDO_GENERAL se copia literal desde inventario
          if (idxEdoGen>=0) setIf(idxEdoGen, HEADERS[idxEdoGen]);
          if (idxProp>=0) setIf(idxProp, HEADERS[idxProp]);
          if (idxCert>=0) setIf(idxCert, HEADERS[idxCert]);

          // ESTADO operativo (select) se deriva inicialmente de EDO_GENERAL ON/OFF
          if (idxEstadoHeader>=0){
            const edoValRaw = (idxEdoGen>=0 ? String(row[idxEdoGen]||'') : '');
            const edoNorm = norm(edoValRaw);
            let estadoVal = '';
            if (edoNorm === 'ON') estadoVal = 'DISPONIBLE';
            else if (edoNorm === 'OFF') estadoVal = 'FUERA DE SERVICIO';
            const estadoInput = getInputByHeader(HEADERS[idxEstadoHeader]);
            if (estadoInput){ estadoInput.value = estadoVal; }
          }
          console.log('[pruebas] buildForm inputs', { equipoHeader: HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|^EQUIPO\s*ACTIVO$|^EQUIPO$/i.test(String(h).replace(/\s*\/\s*/g,'/')) || String(h).trim().toUpperCase()==='EQUIPO / ACTIVO'), hasHash: !!getInputByHeader('#') });
        }

        function ensureDatalist(id, opts){
          let dl = document.getElementById(id);
          if (!dl){ dl = document.createElement('datalist'); dl.id = id; document.body.appendChild(dl); }
          dl.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const v of opts){ const o = document.createElement('option'); o.value = v; frag.appendChild(o); }
          dl.appendChild(frag);
          return dl;
        }

        function buildForm(){
          const host = document.getElementById('form-fields');
          host.innerHTML = '';
          for (const h of HEADERS){
            const labelText = String(h||'').trim();
            const wrap = document.createElement('div'); wrap.className = 'form-field';
            const label = document.createElement('label');
            const visibleLabel = labelText;
            label.textContent = visibleLabel; label.htmlFor = 'fld-' + btoa(labelText).replace(/[^a-z0-9]/gi,'');
            let input;
            const normAll = labelText.toUpperCase();
            if (normAll === 'EJECUCCION'){
              const sel = document.createElement('select'); sel.id = label.htmlFor; sel.name = labelText;
              sel.innerHTML = '<option value="INTERNO">INTERNO</option><option value="EXTERNO">EXTERNO</option>';
              input = sel;
            } else {
              input = document.createElement('input'); input.type='text'; input.id=label.htmlFor; input.name=labelText; input.placeholder=visibleLabel;
            }
            const norm = labelText.toUpperCase().replace(/\s*\/\s*/g,'/');
            const isEquipo = /^(EQUIPO\/ACTIVO|EQUIPO\s*ACTIVO|EQUIPO)$/.test(norm) || labelText.trim().toUpperCase()==='EQUIPO / ACTIVO';
            if (isEquipo){
              // Construir opciones desde ALL_ROWS y EQUIPO_IDX (solo invpnd.csv)
              if (EQUIPO_IDX >= 0 && ALL_ROWS.length){
                const set = new Set();
                for (const r of ALL_ROWS){
                  const v = String(r[EQUIPO_IDX]||'').trim(); if (!v) continue;
                  set.add(v);
                }
                const opts = Array.from(set).sort((a,b)=>a.localeCompare(b));
                ensureDatalist('dl-inventory-equipos', opts);
                input.setAttribute('list','dl-inventory-equipos');
                input.placeholder = 'Equipo/Activo (inventario)';
              }
            }

            // Máscara de fecha corta para campos de fecha en inventario (dd/mm/aa)
            const upperNoAccents = labelText.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
            if (upperNoAccents === 'PROXIMA PRUEBA' ||
                upperNoAccents === 'FECHA REALIZACION' ||
                upperNoAccents === 'FECHA REALIZACION '){
              attachDMYMask(input);
            }
            // Auto-popular campos relacionados al cambiar selección
            const trigger = ()=> autofillFromEquipo(input.value||'');
            input.addEventListener('input', trigger);
            input.addEventListener('change', trigger);
            wrap.appendChild(label); wrap.appendChild(input); host.appendChild(wrap);
          }
          // Si ya hay un valor prellenado en EQUIPO/ACTIVO, disparar autofill
          const equipoHeader = HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|^EQUIPO\s*ACTIVO$|^EQUIPO$/i.test(String(h).replace(/\s*\/\s*/g,'/')) || String(h).trim().toUpperCase()==='EQUIPO / ACTIVO');
          const eqInput = equipoHeader ? getInputByHeader(equipoHeader) : null;
          console.debug('[pruebas] buildForm inputs', { equipoHeader, hasSerial: !!getInputByHeader('Serial') });
          if (eqInput && eqInput.value) autofillFromEquipo(eqInput.value);
        }

        async function loadHeaders(){
          try{
            const res = await fetch(CSV_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error('No se pudo cargar el CSV');
            const txt = await res.text();
            const rows = parseCSV(txt);
            if (!rows.length) throw new Error('CSV vacío');
            // Filtrar EDO=ON si existe columna
            const heads = rows[0].slice();
            HEADERS = heads;
            ALL_ROWS = rows.slice(1);
            // localizar índice de EQUIPO / ACTIVO (con variantes)
            const norm = (s)=> String(s||'').toUpperCase().replace(/\s*\/\s*/g,'/');
            const variants = new Set(['EQUIPO/ACTIVO','EQUIPO ACTIVO','EQUIPO']);
            for (let i=0;i<HEADERS.length;i++){
              const h = HEADERS[i];
              const H = norm(h);
              if (H==='EQUIPO/ACTIVO' || variants.has(H)) { EQUIPO_IDX = i; break; }
            }
            console.log('[pruebas] HEADERS cargados', { EQUIPO_IDX, HEADERS });
            buildForm();
          }catch(err){
            console.error(err);
            document.getElementById('status').textContent = 'Error cargando encabezados';
          }
        }

        function getCurrentUser(){
          try { return firebase?.auth?.().currentUser || null; } catch { return null; }
        }

        function getEditIdFromQuery(){
          try{
            const qs = new URLSearchParams(window.location.search);
            const v = qs.get('editId');
            return v && v.trim() ? v.trim() : null;
          }catch{ return null; }
        }

        async function loadPruebaForEdit(editId){
          if (!editId || !window.db) return;
          const status = document.getElementById('status');
          try{
            const doc = await window.db.collection('pruebas').doc(editId).get();
            if (!doc.exists){
              status.textContent = 'No se encontró la prueba a editar';
              return;
            }
            const payload = doc.data() || {};
            const data = payload.data || {};

            // Normalizar serial: si viene en '#' y 'SERIAL' está vacío, moverlo a 'SERIAL'
            if (Object.prototype.hasOwnProperty.call(data, '#')){
              const hashVal = data['#'];
              const hasSerialKey = Object.prototype.hasOwnProperty.call(data, 'SERIAL');
              const serialVal = hasSerialKey ? data['SERIAL'] : '';
              if (hashVal && !serialVal){
                data['SERIAL'] = hashVal;
                data['#'] = '';
              }
            }
            const form = document.getElementById('prueba-form');
            form.querySelectorAll('input, select, textarea').forEach(inp => {
              const name = inp.name||'';
              if (!name) return;
              if (Object.prototype.hasOwnProperty.call(data, name)){
                inp.value = data[name] || '';
              }
            });
            status.textContent = 'Editando prueba existente';
            const saveBtn = document.getElementById('btn-save');
            if (saveBtn){ saveBtn.textContent = 'Actualizar'; }
          }catch(err){
            console.error('[pruebas] Error al cargar prueba para edición', err);
          }
        }

        async function savePrueba(){
          const btn = document.getElementById('btn-save'); btn.disabled = true;
          const status = document.getElementById('status'); status.textContent = 'Guardando...';
          const form = document.getElementById('prueba-form');
          const data = {};
          form.querySelectorAll('input, select, textarea').forEach(inp => { data[inp.name||''] = inp.value || ''; });
          try{
            const user = getCurrentUser();
            if (!user){ status.textContent = 'Debes iniciar sesión para guardar'; alert('Inicia sesión para crear pruebas'); btn.disabled = false; return; }

            // Autocompletar campos derivados si faltan (fecha realización, próxima prueba, reporte, emisor, técnico, contador, acumulado)
            const norm = (s)=> String(s||'').toUpperCase();
            function headerIndexByVariantsLocal(variantList){
              const headersNorm = HEADERS.map(h=>norm(h));
              for (const v of variantList){
                const idx = headersNorm.indexOf(norm(v));
                if (idx>=0) return idx;
              }
              return -1;
            }
            function setFieldByVariantsLocal(obj, variants, value){
              const idx = headerIndexByVariantsLocal(variants);
              if (idx >= 0){
                const key = HEADERS[idx];
                if (!Object.prototype.hasOwnProperty.call(obj, key) || !obj[key]){
                  obj[key] = value;
                }
              }
            }

            // Fecha de prueba principal (campo fijo del formulario)
            const fechaPruebaRaw = form.querySelector('#fld-fecha-prueba')?.value || '';
            if (fechaPruebaRaw){
              const d = new Date(fechaPruebaRaw);
              if (!isNaN(d.getTime())){
                const pad = (n)=> String(n).padStart(2,'0');
                const fechaISO = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                // FECHA DE PRUEBA / FECHA REALIZACIÓN
                setFieldByVariantsLocal(data,
                  ['FECHA DE PRUEBA','FECHA PRUEBA','FECHA REALIZACION','FECHA REALIZACIÓN','FECHA'],
                  fechaISO
                );
                // PROXIMA PRUEBA (1 año después)
                const dNext = new Date(d.getTime());
                dNext.setFullYear(dNext.getFullYear()+1);
                const proxStr = `${dNext.getFullYear()}-${pad(dNext.getMonth()+1)}-${pad(dNext.getDate())}`;
                setFieldByVariantsLocal(data,
                  ['PROXIMA PRUEBA','PRÓXIMA PRUEBA','PROXIMA','PRÓXIMA'],
                  proxStr
                );
                // ACUMULADO en días desde la fecha de prueba hasta hoy (si aún no se ha calculado)
                if (!data['ACUMULADO']){
                  const today = new Date();
                  const diffMs = today.getTime() - d.getTime();
                  const diffDays = Math.max(0, Math.round(diffMs / (1000*60*60*24)));
                  data['ACUMULADO'] = String(diffDays);
                }
              }
            }

            // Si todavía no hay ACUMULADO, intentar calcularlo usando FECHA REALIZACION (dd/mm/aa) del inventario
            if (!data['ACUMULADO']){
              const idxFechaReal = headerIndexByVariantsLocal(['FECHA REALIZACION','FECHA REALIZACIÓN']);
              if (idxFechaReal >= 0){
                const keyFR = HEADERS[idxFechaReal];
                const valFR = data[keyFR] || '';
                if (valFR){
                  // Formato esperado: dd/mm/aa o dd/mm/aaaa
                  const m = String(valFR).match(/^(\d{2})\/(\d{2})\/(\d{2,4})$/);
                  if (m){
                    const dd = parseInt(m[1],10);
                    const mm = parseInt(m[2],10)-1;
                    let yy = parseInt(m[3],10);
                    if (yy < 100) yy = 2000 + yy; // asumir 20xx
                    const d = new Date(yy, mm, dd);
                    if (!isNaN(d.getTime())){
                      const today = new Date();
                      const diffMs = today.getTime() - d.getTime();
                      const diffDays = Math.max(0, Math.round(diffMs / (1000*60*60*24)));
                      data['ACUMULADO'] = String(diffDays);
                    }
                  }
                }
              }
            }

            // Número de reporte/certificado (consecutivo sencillo por sesión/navegador)
            let hasReporte = false;
            for (let i=0;i<HEADERS.length;i++){
              const h = HEADERS[i];
              if (!h) continue;
              if (norm(h).includes('REPORTE') && data[h]){ hasReporte = true; break; }
            }
            if (!hasReporte){
              let counter = 0;
              try {
                const raw = localStorage.getItem('pruebas:rptCounter');
                counter = raw ? parseInt(raw,10)||0 : 0;
              } catch{}
              counter += 1;
              try { localStorage.setItem('pruebas:rptCounter', String(counter)); } catch{}
              const rpt = `RPT-${String(counter).padStart(4,'0')}`;
              setFieldByVariantsLocal(data,
                ['NO. DE REPORTE / CERTIFICADO','NO. DE REPORTE/CERTIFICADO','NO DE REPORTE / CERTIFICADO','NO DE REPORTE/CERTIFICADO'],
                rpt
              );
            }

            // Emisor y Técnico por defecto desde el usuario actual
            const emisorDefault = user?.email || '';
            setFieldByVariantsLocal(data, ['EMISOR'], emisorDefault);
            setFieldByVariantsLocal(data, ['TECNICO','TÉCNICO'], emisorDefault);

            // Contador simple si no existe
            if (!data['CONTADOR']){
              data['CONTADOR'] = '1';
            }

            const editId = getEditIdFromQuery();
            const col = window.db.collection('pruebas');

            if (editId){
              await col.doc(editId).update({
                data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: user?.email || ''
              });
              status.textContent = 'Prueba actualizada';
              alert('Prueba actualizada');
            } else {
              const payload = {
                headers: HEADERS,
                data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user?.email || ''
              };
              await col.add(payload);
              status.textContent = 'Guardado';
              alert('Prueba creada');
              form.reset();
            }
          }catch(err){
            console.error(err);
            status.textContent = 'Error al guardar';
            alert('Ocurrió un error al guardar');
          } finally {
            btn.disabled = false;
          }
        }

        function init(){
          loadHeaders();
          const status = document.getElementById('status');
          const saveBtn = document.getElementById('btn-save');
          const userSpan = document.getElementById('user-email');
          const loginLink = document.getElementById('login-link');
          const logoutBtn = document.getElementById('logout-btn');

          try {
            firebase.auth().onAuthStateChanged(u=>{
              if (u){
                userSpan.textContent = u.email || '';
                status.textContent = 'Usuario: ' + (u.email||'');
                saveBtn.disabled = false;
                if (logoutBtn) logoutBtn.style.display = '';
                if (loginLink) loginLink.style.display = 'none';
              } else {
                userSpan.textContent = '';
                status.textContent = 'No autenticado';
                saveBtn.disabled = true;
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (loginLink) loginLink.style.display = '';
              }
            });
            logoutBtn?.addEventListener('click', async ()=>{
              try { await firebase.auth().signOut(); window.location.href = 'login.html'; }
              catch(e){ console.error(e); alert('No se pudo cerrar sesión'); }
            });
          } catch {}

          document.getElementById('btn-save').addEventListener('click', savePrueba);
          document.getElementById('btn-cancel').addEventListener('click', ()=>{ window.location.href = 'listapruebas.html'; });

          // Si venimos desde listapruebas con un editId, cargar prueba
          const editId = getEditIdFromQuery();
          if (editId){
            loadPruebaForEdit(editId);
          }
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
      })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
  </body>
</html>
