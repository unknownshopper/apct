<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pruebas PND (pruebas no destructibles) - PCT</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Sistema de creación y gestión de pruebas PCT.">
    <meta name="author" content="PCT">
    <link rel="canonical" href="https://pc-t.mx/pruebas.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pc-t.mx/pruebas.html">
    <meta property="og:title" content="Pruebas PND (pruebas no destructibles) - PCT">
    <meta property="og:description" content="Sistema de creación y gestión de pruebas PCT.">
    <meta property="og:site_name" content="PCT">
    
    <link rel="icon" type="image/x-icon" href="img/logo.ico">
    <link rel="shortcut icon" href="img/logo.ico">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .form-field { display: flex; flex-direction: column; gap: 6px; }
      .form-field label { font-size: 12px; color: #374151; }
      .form-field input, .form-field select, .form-field textarea { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; }
      .form-field textarea { min-height: 100px; resize: vertical; }
      @media (max-width: 640px){ .form-grid { grid-template-columns: 1fr; } }
      .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
      .toolbar .group { display:flex; gap:8px; align-items:center; }
      .page-header { margin-bottom: .5rem; }
      .page-sub { color:#6b7280; font-size:14px; margin:0 0 1rem; }
      .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; background:#fff; }
      .section-title { font-size:14px; color:#374151; margin:0 0 8px; font-weight:600; }
      .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      @media (max-width: 640px){ .two-col { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><img src="img/logopctch.png" alt="Logo" /></div>
      <button class="menu-toggle" aria-label="Abrir menú" aria-controls="primary-nav" aria-expanded="false">☰</button>
      <nav id="primary-nav">
        <ul>
          <li><a href="index.html">Dashboard</a></li>
          <li class="nav-dropdown"><details><summary>Actividad</summary><ul>
            <li><a href="actividad.html">Registro de actividad</a></li>
            <li><a href="regactividad.html">Historial de registros</a></li>
          </ul></details></li>
          <li class="nav-dropdown"><details open><summary>Pruebas</summary><ul>
            <li><a class="active" href="pruebas.html">Pruebas PND (pruebas no destructibles)</a></li>
            <li><a href="stockpruebas.html">PND x equipo</a></li>
            <li><a href="listapruebas.html">Registro PND</a></li>
          </ul></details></li>
          <li><a href="inspeccion.html">Inspección</a></li>
          <li><a href="tareas.html">Tareas</a></li>
          <li><a href="reportes.html">Reportes</a></li>
        </ul>
      </nav>
      <div class="user-box">
        <span id="user-email"></span>
        <a id="login-link" href="login.html">Login</a>
        <button id="logout-btn" type="button" style="display:none">Salir</button>
      </div>
    </header>
    <main class="wide">
      <div class="page-header">
        <h1 style="margin-bottom: .25rem;">Pruebas PND (pruebas no destructibles)</h1>
        <p class="page-sub">Completa los datos de la prueba. Puedes seleccionar un equipo del inventario para autocompletar información relacionada.</p>
      </div>
      <div class="toolbar">
        <div class="group">
          <a class="btn-primary" href="listapruebas.html">Ver Registro PND</a>
        </div>
        <div id="status" class="toolbar-count"></div>
      </div>
      <div class="card" id="orders-inbox">
        <p class="section-title">Órdenes de prueba pendientes</p>
        <div class="two-col" style="margin-bottom:8px; grid-template-columns: repeat(5, 1fr);">
          <input id="ord-f-os" placeholder="Filtrar OS">
          <input id="ord-f-oc" placeholder="Filtrar OC">
          <input id="ord-f-cli" placeholder="Filtrar Cliente">
          <input id="ord-f-eq" placeholder="Filtrar Equipo">
          <select id="ord-f-status">
            <option value="pending" selected>pending</option>
            <option value="in_progress">in_progress</option>
            <option value="done">done</option>
          </select>
        </div>
        <div id="orders-list" style="max-height:260px; overflow:auto;"></div>
      </div>
      <form id="prueba-form">
        <div class="card">
          <p class="section-title">Datos de la prueba</p>
          <div class="two-col">
            <div class="form-field">
              <label for="fld-fecha-prueba">Fecha de prueba</label>
              <input type="date" id="fld-fecha-prueba" name="Fecha de prueba" />
            </div>
            <div class="form-field">
              <label for="fld-resultado">Resultado</label>
              <select id="fld-resultado" name="Resultado">
                <option value="">Selecciona...</option>
                <option value="APROBADO">APROBADO</option>
                <option value="RECHAZADO">RECHAZADO</option>
                <option value="OBSERVADO">OBSERVADO</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <p class="section-title">Información desde inventario</p>
        <div id="form-fields" class="form-grid"></div>
        </div>
        <div class="card">
          <p class="section-title">Observaciones</p>
          <div class="form-field">
            <label for="fld-observaciones">Observaciones</label>
            <textarea id="fld-observaciones" name="Observaciones" placeholder="Notas, condiciones de ensayo, evidencias, etc."></textarea>
          </div>
        </div>
        <div style="margin-top:1rem; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" id="btn-cancel">Cancelar</button>
          <button type="button" class="btn-primary" id="btn-save">Guardar</button>
        </div>
      </form>
    </main>
  <footer>
    <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">
      Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle">
    </a>
  </footer>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      (function(){
        const CSV_URL = 'docs/inventario.csv';
        const GEN_INV_URL = 'docs/INVENTARIO GENERAL PCT 2025 UNIFICADO.csv';
        let HEADERS = [];
        let ALL_ROWS = [];
        let EQUIPO_IDX = -1;
        // Inventario general (ingral.html) como respaldo para serie
        let GEN_HEADERS = [];
        let GEN_ROWS = [];
        let GEN_EQUIPO_IDX = -1;
        let GEN_SERIE_IDX = -1;
        let GEN_EDO_IDX = -1;
        const serieByEquipo = new Map();
        const edoByEquipo = new Map(); // key (normalizado) -> 'ON'|'OFF'|...

        function parseCSV(text){
          const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.length);
          const rows = lines.map(line=>{
            const out = []; const regex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",]*))/g; let m;
            while ((m = regex.exec(line)) !== null) {
              let v = m[1] !== undefined ? m[1].replace(/""/g,'"') : m[2];
              out.push(v ?? '');
            }
            return out;
          });
          return rows;
        }

        function headerIndexByVariants(variantList){
          const norm = (s)=> String(s||'').toUpperCase();
          const headersNorm = HEADERS.map(h=>norm(h));
          for (const v of variantList){
            const idx = headersNorm.indexOf(norm(v));
            if (idx>=0) return idx;
          }
          return -1;
        }

        function headerIndexByVariantsGen(variantList){
          const norm = (s)=> String(s||'').toUpperCase();
          const headersNorm = GEN_HEADERS.map(h=>norm(h));
          for (const v of variantList){
            const idx = headersNorm.indexOf(norm(v));
            if (idx>=0) return idx;
          }
          return -1;
        }

        function safeEscapeAttr(v){
          try { return CSS && typeof CSS.escape==='function' ? CSS.escape(v) : String(v).replace(/"/g,'\\"'); } catch { return String(v).replace(/"/g,'\\"'); }
        }
        function getInputByHeader(headerName){
          const sel = `input[name="${safeEscapeAttr(headerName)}"]`;
          return document.querySelector(sel);
        }

        function autofillFromEquipo(value){
          const val = String(value||'').trim(); if (!val || EQUIPO_IDX<0) return;
          // Normalizar y buscar la primera coincidencia (case-insensitive)
          const norm = (s)=> String(s||'').trim().toUpperCase();
          const row = ALL_ROWS.find(r => norm(r[EQUIPO_IDX]) === norm(val));
          if (!row) return;
          // índices de columnas a popular
          const idxProducto = headerIndexByVariants(['PRODUCTO']);
          const idxDesc = headerIndexByVariants(['DESCRIPCION','DESCRIPCIÓN']);
          const idxPrueba = headerIndexByVariants(['PRUEBA / CALIBRACION','PRUEBA/CALIBRACION','PRUEBA / CALIBRACIÓN','PRUEBA/CALIBRACIÓN']);
          const idxTipo = headerIndexByVariants(['TIPO EQUIPO']);
          const idxArea = headerIndexByVariants(['ÁREA A INSPECIONAR','AREA A INSPECIONAR']);
          // asignar a inputs si existen
          function setIf(idx, header){
            if (idx>=0){ const inp = getInputByHeader(header); if (inp){ inp.value = String(row[idx]||''); } }
          }
          if (idxProducto>=0) setIf(idxProducto, HEADERS[idxProducto]);
          if (idxDesc>=0) setIf(idxDesc, HEADERS[idxDesc]);
          if (idxPrueba>=0) setIf(idxPrueba, HEADERS[idxPrueba]);
          if (idxTipo>=0) setIf(idxTipo, HEADERS[idxTipo]);
          if (idxArea>=0) setIf(idxArea, HEADERS[idxArea]);
          // Popular '#' con número de serie si existe
          const hashInput = getInputByHeader('#');
          if (hashInput){
            let serieVal = '';
            // Buscar SOLO en inventario general (ingral)
            const normKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
            const key = normKey(val);
            const hasKey = serieByEquipo.has(key);
            console.log('[pruebas] lookup serie', { input: val, key, hasKey, mapSize: serieByEquipo.size });
            if (hasKey) serieVal = String(serieByEquipo.get(key)||'');
            if (serieVal) {
              hashInput.value = serieVal;
              console.log('[pruebas] Serie encontrada para', val, '=>', serieVal);
            } else {
              // búsqueda laxa por contiene
              const candidates = [];
              for (const [k,v] of serieByEquipo.entries()){
                if (k.includes(key)) candidates.push([k,v]);
              }
              if (candidates.length){
                hashInput.value = String(candidates[0][1]||'');
                console.log('[pruebas] Serie aproximada usada para', val, '=>', candidates[0]);
              } else {
                // Fallback directo escaneando GEN_ROWS por si el mapa no se llenó como esperamos
                if (GEN_EQUIPO_IDX>=0 && GEN_SERIE_IDX>=0 && GEN_ROWS.length){
                  const direct = GEN_ROWS.find(r => {
                    const ge = String(r[GEN_EQUIPO_IDX]||'');
                    return ge.toUpperCase().trim() === val.toUpperCase().trim()
                      || normKey(ge) === key;
                  });
                  if (direct){
                    const vdir = String(direct[GEN_SERIE_IDX]||'').trim();
                    if (vdir){
                      hashInput.value = vdir;
                      console.log('[pruebas] Serie encontrada via fallback directo para', val, '=>', vdir);
                      return;
                    }
                  }
                }
                console.log('[pruebas] Serie NO encontrada para', val, '(sin candidatos ni fallback)');
              }
            }
          }
          console.log('[pruebas] buildForm inputs', { equipoHeader: HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|^EQUIPO\s*ACTIVO$|^EQUIPO$/i.test(String(h).replace(/\s*\/\s*/g,'/')) || String(h).trim().toUpperCase()==='EQUIPO / ACTIVO'), hasHash: !!getInputByHeader('#') });
        }

        function ensureDatalist(id, opts){
          let dl = document.getElementById(id);
          if (!dl){ dl = document.createElement('datalist'); dl.id = id; document.body.appendChild(dl); }
          dl.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const v of opts){ const o = document.createElement('option'); o.value = v; frag.appendChild(o); }
          dl.appendChild(frag);
          return dl;
        }

        function buildForm(){
          const host = document.getElementById('form-fields');
          host.innerHTML = '';
          for (const h of HEADERS){
            const labelText = String(h||'').trim();
            const wrap = document.createElement('div'); wrap.className = 'form-field';
            const label = document.createElement('label'); label.textContent = labelText; label.htmlFor = 'fld-' + btoa(labelText).replace(/[^a-z0-9]/gi,'');
            let input;
            const normAll = labelText.toUpperCase();
            if (normAll === 'EJECUCCION'){
              const sel = document.createElement('select'); sel.id = label.htmlFor; sel.name = labelText;
              sel.innerHTML = '<option value="INTERNO">INTERNO</option><option value="EXTERNO">EXTERNO</option>';
              input = sel;
            } else {
              input = document.createElement('input'); input.type='text'; input.id=label.htmlFor; input.name=labelText; input.placeholder=labelText;
            }
            const norm = labelText.toUpperCase().replace(/\s*\/\s*/g,'/');
            const isEquipo = /^(EQUIPO\/ACTIVO|EQUIPO\s*ACTIVO|EQUIPO)$/.test(norm) || labelText.trim().toUpperCase()==='EQUIPO / ACTIVO';
            if (isEquipo){
              // Construir opciones desde ALL_ROWS y EQUIPO_IDX
              if (EQUIPO_IDX >= 0 && ALL_ROWS.length){
                const set = new Set();
                const normKey = (s)=> String(s||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
                for (const r of ALL_ROWS){
                  const v = String(r[EQUIPO_IDX]||'').trim(); if (!v) continue;
                  const k = normKey(v);
                  const edo = edoByEquipo.get(k) || 'ON';
                  if (edo === 'ON') set.add(v);
                }
                const opts = Array.from(set).sort((a,b)=>a.localeCompare(b));
                ensureDatalist('dl-inventory-equipos', opts);
                input.setAttribute('list','dl-inventory-equipos');
                input.placeholder = 'Equipo/Activo (inventario)';
              }
            }
            // Auto-popular campos relacionados al cambiar selección
            const trigger = ()=> autofillFromEquipo(input.value||'');
            input.addEventListener('input', trigger);
            input.addEventListener('change', trigger);
            wrap.appendChild(label); wrap.appendChild(input); host.appendChild(wrap);
          }
          // Si ya hay un valor prellenado en EQUIPO/ACTIVO, disparar autofill
          const equipoHeader = HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|^EQUIPO\s*ACTIVO$|^EQUIPO$/i.test(String(h).replace(/\s*\/\s*/g,'/')) || String(h).trim().toUpperCase()==='EQUIPO / ACTIVO');
          const eqInput = equipoHeader ? getInputByHeader(equipoHeader) : null;
          console.debug('[pruebas] buildForm inputs', { equipoHeader, hasHash: !!getInputByHeader('#') });
          if (eqInput && eqInput.value) autofillFromEquipo(eqInput.value);
        }

        async function loadHeaders(){
          try{
            const res = await fetch(CSV_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error('No se pudo cargar el CSV');
            const txt = await res.text();
            // Usar parser general con soporte de comillas
            const rows = parseCSV(txt);
            if (!rows.length) throw new Error('CSV vacío');
            // Filtrar EDO=ON si existe columna
            const heads = rows[0].slice();
            const edoIdx = heads.indexOf('EDO');
            HEADERS = heads;
            ALL_ROWS = rows.slice(1);
            if (edoIdx !== -1) {
              ALL_ROWS = ALL_ROWS.filter(r => String(r[edoIdx]||'').trim().toUpperCase() === 'ON');
            }
            // localizar índice de EQUIPO / ACTIVO (con variantes)
            const norm = (s)=> String(s||'').toUpperCase().replace(/\s*\/\s*/g,'/');
            const variants = new Set(['EQUIPO/ACTIVO','EQUIPO ACTIVO','EQUIPO']);
            for (let i=0;i<HEADERS.length;i++){
              const h = HEADERS[i];
              const H = norm(h);
              if (H==='EQUIPO/ACTIVO' || variants.has(H)) { EQUIPO_IDX = i; break; }
            }
            console.log('[pruebas] HEADERS cargados', { EQUIPO_IDX, HEADERS });
            // Cargar inventario general para respaldo de serie
            await loadGeneralInventory();
            buildForm();
          }catch(err){
            console.error(err);
            document.getElementById('status').textContent = 'Error cargando encabezados';
          }
        }

        function parseCSVGeneral(text){
          try {
            if (window.Papa){
              const res = Papa.parse(text, { delimiter: ',', quoteChar: '"', escapeChar: '"', skipEmptyLines: true });
              return Array.isArray(res?.data) ? res.data : [];
            }
          } catch(e){ console.error('[pruebas] Papa.parse error', e); }
          return parseCSV(text);
        }

        async function loadGeneralInventory(){
          try{
            const url = GEN_INV_URL;
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) { console.log('[pruebas] Fetch general inventory failed', { url, status: res.status }); return; }
            const txt = await res.text();
            const rows = parseCSVGeneral(txt);
            if (!rows.length) return;
            GEN_HEADERS = rows[0].slice();
            GEN_ROWS = rows.slice(1);
            // índices para equipo y serie en inventario general
            GEN_EQUIPO_IDX = headerIndexByVariantsGen(['EQUIPO / ACTIVO','EQUIPO/ACTIVO','EQUIPO ACTIVO','EQUIPO']);
            GEN_SERIE_IDX = headerIndexByVariantsGen(['SERIE','NUMERO DE SERIE','NÚMERO DE SERIE','SERIAL','SERIAL NO','NO. SERIE']);
            GEN_EDO_IDX    = headerIndexByVariantsGen(['EDO','ESTADO']);
            console.log('[pruebas] Inventario unificado cargado', { url, GEN_EQUIPO_IDX, GEN_SERIE_IDX, headers: GEN_HEADERS });
            try { document.getElementById('status').textContent = `Inventario unificado (equip:${GEN_EQUIPO_IDX}, serie:${GEN_SERIE_IDX})`; } catch {}
            if (GEN_EQUIPO_IDX>=0 && GEN_SERIE_IDX>=0){
              serieByEquipo.clear();
              const norm = (s)=> String(s||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
              edoByEquipo.clear();
              for (const r of GEN_ROWS){
                const k = norm(r[GEN_EQUIPO_IDX]);
                const v = String(r[GEN_SERIE_IDX]||'').trim();
                if (k && v && !serieByEquipo.has(k)) serieByEquipo.set(k, v);
                if (GEN_EDO_IDX>=0){ const edo = String(r[GEN_EDO_IDX]||'').trim().toUpperCase(); if (k && edo && !edoByEquipo.has(k)) edoByEquipo.set(k, edo); }
              }
              console.log('[pruebas] Serie map size:', serieByEquipo.size);
              try { document.getElementById('status').textContent += ` | series:${serieByEquipo.size}`; } catch {}
            }
          }catch(e){ console.error('[pruebas] loadGeneralInventory error', e); }
        }

        function getCurrentUser(){
          try { return firebase?.auth?.().currentUser || null; } catch { return null; }
        }

        let CURRENT_ORDER = null;
        async function fetchOrders(){
          try{
            const status = (document.getElementById('ord-f-status')?.value)||'pending';
            let q = window.db.collection('testOrders').where('status','==', status).orderBy('createdAt','desc');
            const snap = await q.limit(300).get();
            return snap.docs.map(d=>({ id:d.id, ...d.data() }));
          }catch(e){ console.warn('[pruebas] fetchOrders', e); return []; }
        }
        function renderOrders(list){
          const host = document.getElementById('orders-list'); if (!host) return; host.innerHTML='';
          const f = {
            os: (document.getElementById('ord-f-os')?.value||'').toLowerCase(),
            oc: (document.getElementById('ord-f-oc')?.value||'').toLowerCase(),
            cli:(document.getElementById('ord-f-cli')?.value||'').toLowerCase(),
            eq: (document.getElementById('ord-f-eq')?.value||'').toLowerCase()
          };
          const match = (o)=> (!f.os || String(o.os||'').toLowerCase().includes(f.os))
            && (!f.oc || String(o.oc||'').toLowerCase().includes(f.oc))
            && (!f.cli|| String(o.cliente||'').toLowerCase().includes(f.cli))
            && (!f.eq || String(o.equipo||'').toLowerCase().includes(f.eq));
          const rows = list.filter(match);
          rows.forEach(o=>{
            const div = document.createElement('div');
            div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
            div.style.border='1px solid #e5e7eb'; div.style.borderRadius='8px'; div.style.padding='8px 10px'; div.style.margin='6px 0';
            div.innerHTML = `<div>
              <div><strong>${o.equipo||'-'}</strong> • ${(o.pruebasRequeridas||[]).join(', ')||'-'}</div>
              <div style="color:#6b7280; font-size:12px;">OS:${o.os||'-'} • OC:${o.oc||'-'} • Cliente:${o.cliente||'-'} • Edo:${o.edo||'-'}</div>
            </div>
            <div><button class="btn-primary" data-id="${o.id}">Iniciar</button></div>`;
            div.querySelector('button')?.addEventListener('click', ()=> startOrder(o));
            host.appendChild(div);
          });
          if (!rows.length){ host.innerHTML = '<div style="color:#6b7280; font-size:12px;">Sin órdenes para los filtros actuales</div>'; }
        }
        async function refreshOrders(){ const list = await fetchOrders(); renderOrders(list); }
        async function startOrder(o){
          CURRENT_ORDER = o;
          const equipoHeader = HEADERS.find(h=>/EQUIPO\s*\/\s*ACTIVO|EQUIPO\s*ACTIVO|EQUIPO/i.test(h.replace(/\s*\/\s*/g,'/')));
          if (equipoHeader){ const inp = getInputByHeader(equipoHeader); if (inp){ inp.value = o.equipo || ''; autofillFromEquipo(o.equipo||''); } }
          const hashInput = getInputByHeader('#'); if (hashInput && o.serial) hashInput.value = o.serial;
          document.getElementById('status').textContent = `Orden en progreso: ${o.equipo||''} (${o.os||o.oc||''})`;
          try{ await window.db.collection('testOrders').doc(o.id).update({ status:'in_progress', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); }
          catch(e){ console.warn('[pruebas] startOrder update', e); }
        }
        async function completeOrderIfAny(){
          if (!CURRENT_ORDER) return;
          try{ await window.db.collection('testOrders').doc(CURRENT_ORDER.id).update({ status:'done', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); CURRENT_ORDER=null; await refreshOrders(); }
          catch(e){ console.warn('[pruebas] completeOrderIfAny', e); }
        }

        async function savePrueba(){
          const btn = document.getElementById('btn-save'); btn.disabled = true;
          const status = document.getElementById('status'); status.textContent = 'Guardando...';
          const form = document.getElementById('prueba-form');
          const data = {};
          form.querySelectorAll('input, select, textarea').forEach(inp => { data[inp.name||''] = inp.value || ''; });
          try{
            const user = getCurrentUser();
            if (!user){ status.textContent = 'Debes iniciar sesión para guardar'; alert('Inicia sesión para crear pruebas'); btn.disabled = false; return; }
            const payload = {
              headers: HEADERS,
              data,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: user?.email || ''
            };
            await window.db.collection('pruebas').add(payload);
            await completeOrderIfAny();
            status.textContent = 'Guardado';
            alert('Prueba creada');
            form.reset();
          }catch(err){
            console.error(err);
            status.textContent = 'Error al guardar';
            alert('Ocurrió un error al guardar');
          } finally {
            btn.disabled = false;
          }
        }

        function init(){
          loadHeaders();
          const status = document.getElementById('status');
          const saveBtn = document.getElementById('btn-save');
          const userSpan = document.getElementById('user-email');
          const loginLink = document.getElementById('login-link');
          const logoutBtn = document.getElementById('logout-btn');

          try {
            firebase.auth().onAuthStateChanged(u=>{
              if (u){
                userSpan.textContent = u.email || '';
                status.textContent = 'Usuario: ' + (u.email||'');
                saveBtn.disabled = false;
                if (logoutBtn) logoutBtn.style.display = '';
                if (loginLink) loginLink.style.display = 'none';
              } else {
                userSpan.textContent = '';
                status.textContent = 'No autenticado';
                saveBtn.disabled = true;
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (loginLink) loginLink.style.display = '';
              }
            });
            logoutBtn?.addEventListener('click', async ()=>{
              try { await firebase.auth().signOut(); window.location.href = 'login.html'; }
              catch(e){ console.error(e); alert('No se pudo cerrar sesión'); }
            });
          } catch {}

          document.getElementById('btn-save').addEventListener('click', savePrueba);
          // Filtros inbox
          ['ord-f-os','ord-f-oc','ord-f-cli','ord-f-eq','ord-f-status'].forEach(id=>{
            const el = document.getElementById(id); if (el) el.addEventListener('input', ()=>{ refreshOrders(); });
          });
          refreshOrders();
          document.getElementById('btn-cancel').addEventListener('click', ()=>{ window.location.href = 'listapruebas.html'; });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
      })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
  </body>
</html>
